<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>手机认证</title>
    <script src="../../script/lib/rem.js"></script>
    <script src="../../script/lib/fastclick.js"></script>
    <link rel="stylesheet" type="text/css" href="../../css/lib/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/login/phonerz.css" />
</head>

<body>
    <div id="wrap">
        <div class="header" id="header">
            <div class="back" @click="back"><img src="../../image/icon-dh-guanbi.png"></div>
        </div>
        <div id="main" class="flex-con">
            <div class="phone_authentication">手机认证</div>
            <div class="form-div">
                <div class="row flex-wrap flex-align">
                    <div class="input-box flex-con">
                        <input type="tel" maxlength="11" placeholder="请输入手机号" v-model="phone">
                        <div class="code">
                            <span v-html="obtain" v-show="default_obtain" @click="obtainClick"></span>
                            <span v-show="!default_obtain"><i>{{count}}</i>秒后重新发送</span>
                        </div>
                    </div>
                </div>
                <div class="row flex-wrap flex-align">
                    <div class="input-box flex-con"><input type="text" maxlength="16" placeholder="请输入验证码" v-model="code"></div>
                </div>
                <div class="submit-btn space-between" @click="authentication">
                    <span class="text-align">认证</span>
                </div>
                <div>
                </div>
            </div>
</body>
<script type="text/javascript" src="../../script/lib/api.js"></script>
<script type="text/javascript" src="../../script/lib/jquery_3.1.1.min.js"></script>
<script type="text/javascript" src="../../script/lib/fastclick.js"></script>
<script type="text/javascript" src="../../script/lib/md5.js"></script>
<script type="text/javascript" src="../../script/lib/swiper.min.js"></script>
<script type="text/javascript" src="../../script/lib/vue.min.js"></script>
<script type="text/javascript" src="../../script/lib/vue_lazyload.min.js"></script>
<script type="text/javascript" src="../../script/lib/api_ajax.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script>

    // apiready = function() {
    //     $api.fixStatusBar($('.header')[0]);
        new Vue({
            el: '#wrap',
            data: {
                phone: '',
                code: '',
                obtain: '获取验证码',
                default_obtain: true,
                count: '',
                timer: null,
                emp: '',
                ount: '',
                verification: ''
            },
            methods: {
                getUserInfo: function() {
                    var _this = this
                    let searchArr = JSON.parse(window.localStorage.getItem('searchData'))
                    console.log(searchArr)
                    _this.emp = searchArr.employeeid;
                    _this.ount = searchArr.account;
                },
                obtainClick: function() {
                    var _this = this;
                    console.log(_this.emp)
                    console.log(_this.ount)
                    console.log(_this.phone)
                    const phoneExp = /^1[3456789]\d{9}$/;
                    if ((!phoneExp.test(_this.phone)) || _this.phone == "") {
                        alert("请输入正确号码")
                    } else {
                        const TIME_COUNT = 60;
                        if (!_this.timer) {
                            _this.count = TIME_COUNT;
                            _this.default_obtain = false;
                            _this.timer = setInterval(() => {
                                if (_this.count > 0 && _this.count <= TIME_COUNT) {
                                    _this.count--;
                                } else {
                                    _this.default_obtain = true;
                                    clearInterval(this.timer);
                                    _this.timer = null;
                                }
                            }, 1000)
                        };
                        $.ajax({
                            method: "post",
                            url: beUrl + 'phoneauth/authen',
                            data: {
                                account: _this.ount,
                                employeeid: _this.emp,
                                phone: _this.phone
                            },
                            success: function(res) {
                                console.log(res)
                                _this.verification = res.random;
                                console.log(_this.verification)

                            }
                        })

                    }
                },
                authentication: function() {
                    var self = this;
                    var phoneExp = /^1[3456789]\d{9}$/;
                    if (self.phone == "" || self.phone == null || self.phone == undefined) {
                        alert("请输入账号")
                        return;
                    } else if (!phoneExp.test(self.phone)) {
                        alert("请输入账号2222")
                        return;
                    };
                    if (self.code == "" || self.code == null || self.code == undefined) {
                        alert("请输入验证码")
                        return;
                    };
                    wHrefJs.openWin({
                        name: 'main',
                        path: '../main.html'
                    });
                    console.log(self.ount)
                    console.log(self.emp)
                    console.log(self.phone)
                    console.log(self.code)
                    // if (self.code == self.verification || phoneExp.test(self.phone)) {
                        $.ajax({
                            method: "post",
                            url: beUrl + 'phoneauth/bind',
                            data: {
                                account: self.ount,
                                employeeid: self.emp,
                                phone: self.phone,
                                authcode:self.code
                            },
                            success: function(res) {
                                console.log(res)
                                if(res.code==5){
                                    alert(res.msg)
                                }

                            }
                        })

                    // }
                },
                back() {
                    // wHrefJs.openWin({
                    //     name: 'login',
                    //     path: './login.html'
                    // })
                     window.location.href = "login.html"
                }
            },
            mounted() {
                this.getUserInfo();
            }

        })
    // }
</script>

</html>
