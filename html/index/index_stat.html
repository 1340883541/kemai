<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>今日统计</title>
    <script src="../../script/lib/rem.js"></script>
    <script src="../../script/lib/fastclick.js"></script>
    <link rel="stylesheet" type="text/css" href="../../css/lib/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
    <link rel="stylesheet" type="text/css" href="../../css/index/index.css" />
    <style>
        html,
        body {
            min-height: 100%;
        }
        body {
            background-color: #f7f7f7;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <div class="stat-header">
            <div class="stat-fixed-header">
                <div class="stat-header-t">
                    <div class="back" onclick="wBackThisFunc()"></div>
                    <div class="center">今日统计</div>
                    <div class="place"></div>
                </div>
                <div class="stat-header-nav flex-wrap">
                    <div class="flex-con nav0 nav" @click="filterNav($event,0)" ><span v-text="currTypeTxt"></span><i></i></div>
                    <div class="flex-con nav1 nav" @click="filterNav($event,1)"><span v-text="currDateTxt"></span><i></i></div>
                    <div class="stat-nav-box stat-nav-box0">
                        <ul>
                            <li v-for="(type,index) in typeList" :class="{'curr':index===currTypeIndex}" @click.stop="handleSwitchType(index,type.value,type.name)"><span v-text="type.name"></span><i></i></li>
                        </ul>
                    </div>
                    <div class="stat-nav-box stat-nav-box1">
                        <ul>
                            <li v-for="(date,index) in dateList" :class="{'curr':index===currDateIndex}" @click.stop="handleSwitchDate(index,date.value,date.name)"><span v-text="date.name"></span><i></i></li>
                        </ul>
                    </div>
                </div>

            </div>
            <div class="stat-header-place"></div>
        </div>

        <div class="stat-nav-bg" @click="closeFilterNav"  ontouchmove="event.preventDefault();"></div>
        <div class="stat-contain">
            <ul>
                <li class="clear" v-for="(info,index) in infoList" @click="skipDetail(info.id,info.phone,info.belongState)" :key="index">
                    <div class="fl name" v-text="info.name"></div>
                    <div class="fr time">{{info.time | dateFilter}}</div>
                    <span v-if="info.belongState == 1"></span>
                </li>
                <!-- 无更多数据 -->
                <div class="not-more-filter" id="not-more">没有更多数据</div>
            </ul>
            <!-- 空页面 -->
            <empty-con :is-show="infoList.length === 0" txt="暂无数据"></empty-con>
        </div>
    </div>
</body>
<script type="text/javascript" src="../../script/lib/api.js"></script>
<script type="text/javascript" src="../../script/lib/jquery_3.1.1.min.js"></script>
<script type="text/javascript" src="../../script/lib/md5.js"></script>
<script type="text/javascript" src="../../script/lib/vue.min.js"></script>
<script type="text/javascript" src="../../script/lib/vue_lazyload.min.js"></script>
<script type="text/javascript" src="../../script/lib/api_ajax.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script>
    var statV = null;
    apiready = function() {
        $api.fixStatusBar($('.stat-header')[0]);
        $api.fixStatusBar($('.stat-fixed-header')[0]);
        var param = api.pageParam;
        // 下拉加载更多
        api.addEventListener({
            name: 'scrolltobottom'
        }, function(ret, err){
            if(statV.page++ < statV.totalPage){
                statV.getData(true);
            }else{
                if(statV.totalPage > 1){
                    $('#not-more').show();
                }
            }
        });

        // 跟进成功
        api.addEventListener({
            name: 'followRecordSuccessRefresh'
        }, function(ret, err){
            statV.page = 1;
            statV.getData();
        });
        statV = new Vue({
            el: '#wrapper',
            data: {
                // 统计类型
                typeList:[],
                currTypeTxt:'',
                currTypeValue:'',
                currTypeIndex:0,

                userInfo:{},
                // 日期
                dateList:[],
                currDateValue:1,
                currDateTxt:'今日',
                currDateIndex:0,
                // 分页数据
                page:1,
                totalPage:1,
                pageSize:10,
                infoList:[]
            },
            created:function(){
                this.currTypeTxt = param.statTypeTxt;
                this.userInfo = wPref.getPrefs({
                    key:'userInfo'
                });
                this.userInfo = (this.userInfo != '' ? JSON.parse(this.userInfo) : {});
            },
            mounted: function() {
                this.fetchStatData();
            },
            filters:{
                dateFilter:function(d){
                    var date = new Date(d);
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var day = date.getDate();
                    month = (month+'').length > 1 ? month : '0' + month;
                    day = (day+'').length > 1 ? day : '0' + day;
                    return year + '/' + month + '/' + day;
                }
            },
            methods: {
                // 获取统计数据来源
                fetchStatData:function(){
                    var _this = this;
                    wApiAjax({
                        url:'workbench/select',
                        headers:{
                            token:TOKEN_DATA
                        },
                        success:function(res){
                            if(res && res.code == 1){
                                _this.typeList = res.data.customerSourceslist;
                                _this.dateList = res.data.customerSatauslist;
                                res.data.customerSourceslist.forEach(function(v,i){
                                    if(v.name === _this.currTypeTxt){
                                        _this.currTypeIndex = i;
                                        _this.currTypeValue = v.value;
                                    }
                                })
                                _this.getData();
                            }
                        }
                    })
                },
                getData:function(isLoadMore){
                    isLoadMore = isLoadMore || false;
                    var _this = this;
                    wDialog.showProgress();
                    console.log('stat request data: '+JSON.stringify({
                        employeeid:_this.userInfo.employeeid,
                        search_type:_this.currTypeValue,
                        search_date:_this.currDateValue,
                        pageNo:_this.page,
                        pageSize:_this.pageSize
                    }))
                    wApiAjax({
                        url:"workbench/statislist",
                        method:'post',
                        headers:{
                            token:TOKEN_DATA
                        },
                        data:{
                            employeeid:_this.userInfo.employeeid,
                            search_type:_this.currTypeValue,
                            search_date:_this.currDateValue,
                            pageNo:_this.page,
                            pageSize:_this.pageSize
                        },
                        success:function(res){
                            wDialog.hideProgress();
                            console.log(JSON.stringify(res))
                            if(res.code == 1){
                                if(!isLoadMore){
                                    _this.infoList = res.data || [];
                                    _this.totalPage = Math.floor(res.count / _this.pageSize);
                                    console.log(_this.totalPage)
                                    if(_this.totalPage === 1){
                                        $('#not-more').show();
                                    }else{
                                        $('#not-more').hide();
                                    }
                                }else{
                                    _this.infoList = _this.infoList.concat(res.data);
                                }
                            }else{
                                wDialog.toast({
                                    msg:res.msg
                                })
                            }
                        }
                    });
                },
                // 筛选今日统计nav
                filterNav: function(e, i) {
                    var tag = e.currentTarget;
                    if ($(tag).hasClass('curr')) {
                        $('.stat-nav-bg').hide();
                        $(tag).removeClass('curr');
                        $('.stat-nav-box' + i).hide();
                        this.allowScroll();
                    } else {
                        $('.stat-nav-bg').show();
                        $(tag).addClass('curr').siblings('.nav').removeClass('curr');
                        $('.stat-nav-box' + i).show().siblings('.stat-nav-box').hide();
                        this.noScroll();
                    }
                },
                // 关闭筛选
                closeFilterNav: function() {
                    $('.stat-header-nav .nav').removeClass('curr');
                    $('.stat-nav-bg').hide();
                    $('.stat-nav-box').hide();
                    this.allowScroll();
                },
                noScroll:function(){
                    $('.stat-contain').addClass('fixed');
                },
                allowScroll:function(){
                    $('.stat-contain').removeClass('fixed');
                },
                // 切换
                handleSwitchType:function(idx,value,name){
                    if(this.currTypeIndex === idx){
                        console.log('已经被选中')
                    }else{
                        this.currTypeValue = value;
                        this.currTypeTxt = name;
                        this.currTypeIndex = idx;
                        this.page = 1;
                        this.getData();
                    }
                    this.closeFilterNav();
                },
                // 日期
                handleSwitchDate:function(idx,value,name){
                    if(this.currDateIndex === idx){
                        console.log('已经被选中')
                    }else{
                        this.currDateTxt = name;
                        this.currDateValue = value;
                        this.currDateIndex = idx;
                        this.page = 1;
                        this.getData();
                    }
                    this.closeFilterNav();
                },
                skipDetail:function(id,phone,state){
                    // 不能查看
                    if(state == 1){
                        wDialog.toast({
                            msg:'不能查看非自己负责的客户'
                        })
                    }else{
                        wHrefJs.openWin({
                            name:'customerDetail',
                            path:'../customer/customer_detail.html',
                            param:{
                                cusId:id,
                                cusPhone:phone,
                                isWork:1
                            }
                        })
                    }
                }
            }
        })
    }
</script>

</html>
