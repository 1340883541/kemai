<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>工作台-首页</title>
    <script src="../../script/lib/rem.js"></script>
    <script src="../../script/lib/fastclick.js"></script>
    <link rel="stylesheet" type="text/css" href="../../css/lib/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/index/index.css" />
</head>

<body>
    <div id="wrapper">
        <div class="fixed-header"></div>
        <div class="header">
            <div class="i-title">工作台</div>
            <div class="offline-box clear" id="offline-box" @click="skipOfflinePage">
                <div class="fl left">
                    <i></i>网络不给力，请检查您的网络设置
                </div>
                <div class="fr right"></div>
            </div>
        </div>
        <!-- 客户 -->
        <div class="kh-box">
            <div class="kh-binner">
                <div class="kh-add" @click="skipNewCustomer('全部')">今日新增</div>
                <div class="kh-nav">
                    <ul class="clear">
                        <li class="fl bor-r" @click="skipNewCustomer('网络客户')">
                            <p class="kh-t">网络客户</p>
                            <p class="kh-c" v-text="network"></p>
                        </li>
                        <li class="fl" @click="skipNewCustomer('渠道客户')">
                            <p class="kh-t">渠道客户</p>
                            <p class="kh-c" v-text="channel"></p>
                        </li>
                        <li class="fl bor-r" @click="skipNewCustomer('资源池客户')">
                            <p class="kh-t">资源池客户</p>
                            <p class="kh-c" v-text="respool"></p>
                        </li>
                        <li class="fl" @click="skipNewCustomer('销售客户')">
                            <p class="kh-t">销售客户</p>
                            <p class="kh-c" v-text="market"></p>
                        </li>
                    </ul>
                    <div class="kh-hline"></div>
                    <div class="kh-vline"></div>
                </div>
            </div>
        </div>
        <!-- 消息提醒 -->
        <div class="msg-title">
            <div class="i-title">消息提醒</div>
        </div>
        <div class="msg-box" v-cloak>
            <div class="msg-binner clear">
                <div class="fl msg-lis" @click="skipMessage(0,'change_principal')">
                    <div class="msg-icon-box">
                        <div class="msg-icon msg-icon-1">
                            <div class="read-msg" v-if="change_principal">
                                <span>{{change_principal|messageFilter}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="msg-txt">负责人变更</div>
                </div>
                <div class="fl msg-lis" @click="skipMessage(1,'follow')">
                    <div class="msg-icon-box">
                        <div class="msg-icon msg-icon-2">
                            <div class="read-msg" v-if="follow">
                                <span>{{follow|messageFilter}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="msg-txt">跟进提醒</div>
                </div>
                <div class="fl msg-lis" @click="skipMessage(2,'recovery')">
                    <div class="msg-icon-box">
                        <div class="msg-icon msg-icon-3">
                            <div class="read-msg" v-if="recovery">
                                <span>{{recovery|messageFilter}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="msg-txt">回收提醒</div>
                </div>
                <div class="fl msg-lis" @click="skipMessage(3,'resource')">
                    <div class="msg-icon-box">
                        <div class="msg-icon msg-icon-4">
                            <div class="read-msg" v-if="resource">
                                <span>{{resource|messageFilter}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="msg-txt">资源回收</div>
                </div>
                <div class="fl msg-lis" @click="skipMessage(4,'subscription')">
                    <div class="msg-icon-box">
                        <div class="msg-icon msg-icon-5">
                            <div class="read-msg" v-if="subscription">
                                <span>{{subscription|messageFilter}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="msg-txt">认购提醒</div>
                </div>
                <div class="fl msg-lis" @click="skipMessage(5,'sign')">
                    <div class="msg-icon-box">
                        <div class="msg-icon msg-icon-6">
                            <div class="read-msg" v-if="sign">
                                <span>{{sign|messageFilter}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="msg-txt">签约提醒</div>
                </div>
                <div class="fl msg-lis" @click="skipMessage(6,'pay')">
                    <div class="msg-icon-box">
                        <div class="msg-icon msg-icon-7">
                            <div class="read-msg" v-if="pay">
                                <span>{{pay|messageFilter}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="msg-txt">缴费提醒</div>
                </div>
                <div class="fl msg-lis" @click="skipMessage(7,'subscriptionBook')">
                    <div class="msg-icon-box">
                        <div class="msg-icon msg-icon-8">
                            <div class="read-msg" v-if="subscriptionBook">
                                <span>{{subscriptionBook|messageFilter}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="msg-txt">认购书提醒</div>
                </div>
            </div>
        </div>
        <!-- 今日统计 -->

        <div class="tj-title">
            <div class="i-title">今日统计</div>
        </div>
        <div class="tj-box">
            <div class="tj-binner clear">
                <div class="tj-lis fl" @click="skipStat(1)">
                    <div class="tj-icon tj-icon-1"></div>
                    <div class="tj-txt">
                        <p class="p-t" v-text="vaildcall"></p>
                        <p class="p-d">客户通话(个)</p>
                    </div>
                </div>
                <div class="tj-lis fr" @click="skipStat(2)">
                    <div class="tj-icon tj-icon-2"></div>
                    <div class="tj-txt">
                        <p class="p-t" v-text="noanscall"></p>
                        <p class="p-d">未接听(个)</p>
                    </div>
                </div>
                <div class="tj-lis fl" @click="skipStat(3)">
                    <div class="tj-icon tj-icon-3"></div>
                    <div class="tj-txt">
                        <p class="p-t" v-text="todaynotefollow"></p>
                        <p class="p-d">短信跟进(个)</p>
                    </div>
                </div>
                <div class="tj-lis fr" @click="skipStat(4)">
                    <div class="tj-icon tj-icon-4"></div>
                    <div class="tj-txt">
                        <p class="p-t" v-text="lookwechatcount"></p>
                        <p class="p-d">查看微信(个)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../../script/lib/api.js"></script>
<script type="text/javascript" src="../../script/lib/jquery_3.1.1.min.js"></script>
<script type="text/javascript" src="../../script/lib/md5.js"></script>
<script type="text/javascript" src="../../script/lib/vue.min.js"></script>
<script type="text/javascript" src="../../script/lib/vue_lazyload.min.js"></script>
<script type="text/javascript" src="../../script/lib/api_ajax.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script>
    var indexV = null;
    apiready = function() {
        $api.fixStatusBar($('.header')[0]);
        $api.fixStatusBar($('.fixed-header')[0]);
        api.addEventListener({
            name: 'refreshMessage'
        }, function(ret, err){
            // indexV.getMessageData();
        });
        // // 下拉刷新
        // api.setCustomRefreshHeaderInfo({
        //     bgColor: '#f7f7f7',
        //     isScale: true,
        //     loadAnimInterval:120,
        //     image: {
        //         pull: [
        //             'widget://image/load-xl-s1.png',
        //             'widget://image/load-xl-s2.png'
        //         ],
        //         load: [
        //             'widget://image/load-xl-1.png',
        //             'widget://image/load-xl-2.png',
        //             'widget://image/load-xl-3.png',
        //             'widget://image/load-xl-4.png',
        //             'widget://image/load-xl-5.png',
        //             'widget://image/load-xl-6.png',
        //             'widget://image/load-xl-7.png',
        //             'widget://image/load-xl-8.png',
        //             'widget://image/load-xl-9.png',
        //             'widget://image/load-xl-10.png',
        //             'widget://image/load-xl-11.png',
        //             'widget://image/load-xl-12.png'
        //         ]
        //     }
        // }, function() {
        //     indexV.fetchData(api.refreshHeaderLoadDone)
        //     //下拉刷新被触发，自动进入加载状态，使用 api.refreshHeaderLoadDone() 手动结束加载中状态
        //     //下拉刷新被触发，使用 api.refreshHeaderLoadDone() 结束加载中状态
        // });
        // api.setFrameAttr({
        //     bounces:true
        // });

        indexV = new Vue({
            el: '#wrapper',
            data: {
                employeeid: '',
                account: '',
                market:0,  //今日新增销售客户
                network:0, //今日新增网络客户
                channel:0, //今日新增渠道客户
                respool:0, //今日新增资源池客户
                vaildcall:0, //今日统计有效通话
                noanscall:0, //今日统计未接听通话
                resource:0, //资源回收
                sign:0,  //签约消息
                pay:0,  //缴费消息
                change_principal:0,//负责人变更
                recovery:0, //回收提醒
                subscription:0,//认购消息
                follow:0, //跟进提醒
                subscriptionBook:0, //认购书提醒
                todaynotefollow:0,  //微信次数
                lookwechatcount:0, //短信跟进个数
                userInfo:'',
                notificationInfo:{}
            },
            mounted: function() {
                this.netWorkStatus();
                this.fetchStatData();
                this.getMessageData();
                this.fetchNewData();
            },
            filters:{
                messageFilter:function(n){
                    return n > 99 ? '99+' : n;
                }
            },
            methods: {
                skipMessage:function(i,remindName){
                    if(i === 1){
                        // if(this.notificationInfo[remindName] === 'off'){
                        //     wDialog.toast({
                        //         msg:'当前的消息提醒还未开启通知。'
                        //     })
                        // }else{
                            wHrefJs.openWin({
                                name:'customerFollowHeader',
                                path:'../customer/customer_follow_header.html'
                            })
                        // }
                    }
                    else if(i === 2){
                        // if(this.notificationInfo[remindName] === 'off'){
                        //     wDialog.toast({
                        //         msg:'当前的消息提醒还未开启通知。'
                        //     })
                        // }else{
                            wHrefJs.openWin({
                                name:'customerRecycleHeader',
                                path:'../customer/customer_recycle_header.html'
                            })
                        // }
                    }else{
                        wDialog.toast({
                            msg:'暂不支持查看，敬请期待'
                        })
                    }
                },
                // 判断网络状态
                netWorkStatus:function(){
                    listenOnline.offline(function(){
                        $('#offline-box').show();
                    });
                    listenOnline.online(function(){
                        $('#offline-box').hide();
                    });
                    var lineStatus = listenOnline.lineStatus();
                    if(lineStatus == 'unknown' || lineStatus == 'none' || lineStatus == '2g'){
                        $('#offline-box').show();
                    }else{
                        $('#offline-box').hide();
                    }
                },
                // 跳转到offline
                skipOfflinePage:function(){
                    wHrefJs.openWin({
                        name:'offline',
                        path:'../person/solution.html'
                    })
                },
                // 获取消息提醒的数据
                getMessageData:function(cb){
                    var _this = this;
                    this.userInfo = wPref.getPrefs({
                        key:'userInfo'
                    });
                    this.userInfo = (this.userInfo != '' ? JSON.parse(this.userInfo) : {});
                    wApiAjax({
                        url:"msgRemind/getAllNoticeCount",
                        method:'get',
                        headers:{
                            token:TOKEN_DATA
                        },
                        data:{
                            employeeid:_this.userInfo.employeeid
                        },
                        success:function(res){
                            console.log('inn11111111111'+JSON.stringify(res))
                            if(res.code == 200){
                                _this.notificationInfo = res.info || {};
                                _this.notificationInfo.switch = res.switch;
                                if(res.switch == 0){
                                    _this.resource = 0;
                                    _this.sign = 0;
                                    _this.pay = 0;
                                    _this.change_principal = 0;
                                    _this.recovery = 0;
                                    _this.subscription = 0;
                                    _this.follow = 0;
                                    _this.subscriptionBook = 0;
                                }else{
                                    res.info = res.info || {};
                                    _this.resource = res.info.resource == 'off' ? 0 : res.info.resource;
                                    _this.sign = res.info.sign == 'off' ? 0 : res.info.sign;
                                    _this.pay = res.info.pay == 'off' ? 0 : res.info.pay;
                                    _this.change_principal = res.info.change_principal == 'off' ? 0 : res.info.change_principal;
                                    _this.recovery =  res.info.recovery == 'off' ? 0 : res.info.recovery;
                                    _this.subscription =  res.info.subscription == 'off' ? 0 : res.info.subscription;
                                    _this.follow =  res.info.follow == 'off' ? 0 : res.info.follow;
                                    _this.subscriptionBook =  res.info.subscriptionBook == 'off' ? 0 : res.info.subscriptionBook;
                                }
                            }
                            cb && typeof cb === 'function' && cb();
                        }
                    })
                },
                // 获取今日新增数据
                fetchNewData:function(cb){
                    var _this = this;
                    this.userInfo = wPref.getPrefs({
                        key:'userInfo'
                    });
                    this.userInfo = (this.userInfo != '' ? JSON.parse(this.userInfo) : {});
                    wDialog.showProgress();
                    wApiAjax({
                        url:'workbench/todayAdd',
                        headers:{
                            token:TOKEN_DATA
                        },
                        data:{
                            employeeid:_this.userInfo.employeeid
                        },
                        success:function(res){
                            if(res.code == 1){
                                _this.market = res.market;
                                _this.network = res.network;
                                _this.channel = res.channel;
                                _this.respool = res.respool;
                            }
                            wDialog.hideProgress();
                        },
                        fail:function(){

                        }
                    })
                },
                // 获取今日统计数据
                fetchStatData:function(){
                    var _this = this;
                    this.userInfo = wPref.getPrefs({
                        key:'userInfo'
                    });
                    this.userInfo = (this.userInfo != '' ? JSON.parse(this.userInfo) : {});
                    wDialog.showProgress();
                    wApiAjax({
                        url:'workbench/todaySta',
                        headers:{
                            token:TOKEN_DATA
                        },
                        data:{
                            employeeid:_this.userInfo.employeeid
                        },
                        success:function(res){
                            if(res.code == 1){
                                _this.vaildcall = res.vaildcall;
                                _this.noanscall = res.noanscall;
                                _this.todaynotefollow = res.todaynotefollow;
                                _this.lookwechatcount = res.lookwechatcount;
                            }
                        },
                        fail:function(){

                        }
                    })
                },
                // 跳转新增
                skipNewCustomer: function(val) {
                    var self = this;
                    wHrefJs.openWin({
                        name: 'newCustomerHeader',
                        path: './new_customer_header.html',
                        param: {
                            origin: val
                        },
                        bgColor: '#f7f7f7'
                    })
                },
                // 跳转到今日统计
                skipStat:function(i){
                    var _this = this;
                    wHrefJs.openWin({
                        name:'indexStat',
                        path:'./index_stat.html',
                        param:{
                            statType:i
                        }
                    })
                }
            }
        })
    }
    // 刷新数据
    function refrshIndexData(){
        indexV.fetchNewData()
        indexV.fetchStatData();
        indexV.getMessageData();
    }
</script>

</html>
