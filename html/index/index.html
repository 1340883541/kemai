<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>工作台-首页</title>
    <script src="../../script/lib/rem.js"></script>
    <script src="../../script/lib/fastclick.js"></script>
    <link rel="stylesheet" type="text/css" href="../../css/lib/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/lib/swiper.css" />
    <link rel="stylesheet" type="text/css" href="../../css/index/index.css" />
</head>

<body>
    <div id="wrapper">
        <!-- header -->
        <div class="index-header">
            <div class="index-title" id="index-title">
                <div class="index-tilte-txt">工作台</div>
                <!-- 断网 -->
                <div class="offline-box clear" id="offline-box" @click="skipOfflinePage">
                    <div class="fl left">
                        <i></i>网络不给力，请检查您的网络设置
                    </div>
                    <div class="fr right"></div>
                </div>
            </div>
            <div class="head-bg head-bluebg" id="head-bg"></div>
            <div class="head-box head-bluebox">
                <div class="head-bt clear">
                    <div class="fl left"></div>
                </div>
                <div class="new-follow-box">
                    <div class="index-cap">新增资源跟进</div>
                    <div class="head-bb flex-wrap">
                        <div class="flex-con head-bb-lis" @click="skipNewCustomer('公司资源')">
                            <div class="head-bb-t head-bb-t1">公司资源</div>
                            <div class="head-bb-b" v-text="corSour"></div>
                        </div>
                        <div class="flex-con head-bb-lis" @click="skipNewCustomer('销售资源')">
                            <div class="head-bb-t head-bb-t2">销售资源</div>
                            <div class="head-bb-b" v-text="market"></div>
                        </div>
                        <div class="flex-con head-bb-lis" @click="skipNewCustomer('渠道资源')">
                            <div class="head-bb-t head-bb-t3">渠道资源</div>
                            <div class="head-bb-b" v-text="channel"></div>
                        </div>
                        <div class="flex-con head-bb-lis" @click="skipNewCustomer('资源池')">
                            <div class="head-bb-t head-bb-t3">资源池</div>
                            <div class="head-bb-b" v-text="respool"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="system-follow-box">
            <div class="index-cap">系统资源跟进</div>
            <div class="system-follow flex-wrap">
                <div class="flex-con system-lis" @click="handleSkipSystemList('长期')">
                    <div class="sys-lbox sys-lbox5">
                        <div class="system-t">长期</div>
                        <div class="system-b" v-text="longTerm">2</div>
                    </div>
                </div>
                <div class="flex-con system-lis" @click="handleSkipSystemList('中期')">
                    <div class="sys-lbox sys-lbox6">
                        <div class="system-t">中期</div>
                        <div class="system-b" v-text="funcFormateSystemCount(metTerm)">2</div>
                    </div>
                </div>
                <div class="flex-con system-lis" @click="handleSkipSystemList('短期')">
                    <div class="sys-lbox sys-lbox7">
                        <div class="system-t">短期</div>
                        <div class="system-b" v-text="funcFormateSystemCount(shortTerm)">2</div>
                    </div>
                </div>
                <div class="flex-con system-lis" @click="handleSkipSystemList('未接')">
                    <div class="sys-lbox sys-lbox5">
                        <div class="system-t">未接</div>
                        <div class="system-b" v-text="funcFormateSystemCount(unansweredCus)"></div>
                    </div>
                </div>
                <div class="flex-con system-lis" @click="handleSkipSystemList('成交')">
                    <div class="sys-lbox sys-lbox6">
                        <div class="system-t">成交</div>
                        <div class="system-b" v-text="funcFormateSystemCount(dealCus)"></div>
                    </div>
                </div>
                <div class="flex-con system-lis"></div>
            </div>
        </div>
        <!-- 消息提醒 -->
        <div class="message-box">
            <div class="index-cap">消息提醒</div>
            <div class="message-lis flex-wrap flex-center">
                <div class="flex-con message-ls" @click="skipMessage(2,'recovery')">
                    <div class="msg-icon msg-icon1">
                        <span class="msg-count" v-if="recovery" v-cloak>{{recovery|messageFilter}}</span>
                    </div>
                    <div class="msg-txt">回收提醒</div>
                </div>
                <div class="flex-con message-ls" @click="skipMessage(5,'sign')">
                    <div class="msg-icon msg-icon2">
                        <span class="msg-count" v-if="sign" v-cloak>{{sign|messageFilter}}</span>
                    </div>
                    <div class="msg-txt">签约提醒</div>
                </div>
                <div class="flex-con message-ls" @click="skipMessage(6,'pay')">
                    <div class="msg-icon msg-icon3">
                        <span class="msg-count" v-if="pay" v-cloak>{{pay|messageFilter}}</span>
                    </div>
                    <div class="msg-txt">缴费提醒</div>
                </div>
            </div>
        </div>
        <!-- 今日统计 -->
        <div class="stat-box">
            <div class="index-cap">今日统计</div>
            <div class="stat-lis flex-wrap">
                <div class="flex-con stat-ls bor-r" @click="skipStat('拨号')">
                    <div class="stat-ls-t stat-ls-t1">拨号(次)</div>
                    <div class="stat-ls-b" v-text="allCallTimes"></div>
                </div>
                <div class="flex-con stat-ls" @click="skipStat('查看微信')">
                    <div class="stat-ls-t stat-ls-t4">查看微信(个)</div>
                    <div class="stat-ls-b" v-text="lookwechatcount"></div>
                </div>
                <div class="flex-con stat-ls bor-r" @click="skipStat('未接')">
                    <div class="stat-ls-t stat-ls-t2">未接(次)</div>
                    <div class="stat-ls-b" v-text="noanscall"></div>
                </div>
                <div class="flex-con stat-ls" @click="skipStat('号码异常')">
                    <div class="stat-ls-t stat-ls-t2">号码异常(个)</div>
                    <div class="stat-ls-b" v-text="abnormalNum"></div>
                </div>
                <div class="flex-con stat-ls bor-r" @click="skipStat('接通')">
                    <div class="stat-ls-t stat-ls-t1">接通(次)</div>
                    <div class="stat-ls-b" v-text="vaildcall"></div>
                </div>
                <div class="flex-con stat-ls">
                </div>
            </div>
        </div>
        <!-- 跳转到新增客户页面 -->
        <div class="skip-add" @click.stop="handleSkipAddCustomer">
            <i></i>
            <!-- <i></i><span>新增客户</span> -->
        </div>
        <div onclick="api.openWin({name:'managerNewFollow',url:'manager_new_follow.html'})">
            hhhh
        </div>
    </div>
</body>
<script type="text/javascript" src="../../script/lib/api.js"></script>
<script type="text/javascript" src="../../script/lib/jquery_3.1.1.min.js"></script>
<script type="text/javascript" src="../../script/lib/swiper.min.js"></script>
<script type="text/javascript" src="../../script/lib/md5.js"></script>
<script type="text/javascript" src="../../script/lib/vue.min.js"></script>
<script type="text/javascript" src="../../script/lib/vue_lazyload.min.js"></script>
<script type="text/javascript" src="../../script/lib/api_ajax.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script>
    var indexV = null;
    apiready = function() {
        var top = api.safeArea.top;
        $('#head-bg').css('padding-top',top);
        $('.index-header .head-box').css('padding-top',top);
        $('#index-title').css('padding-top',top);
        $('#offline-box').css('top',top+48);
        indexV = new Vue({
            el: '#wrapper',
            data: {
                employeeid: '',
                account: '',
                market: 0, //今日销售渠道
                channel: 0, //今日渠道客户
                corSour: 0, //今日公司资源
                respool: 0, //今日资源池客户

                resource: 0, //资源回收
                sign: 0, //签约消息
                pay: 0, //缴费消息
                change_principal: 0, //负责人变更
                recovery: 0, //回收提醒
                subscription: 0, //认购消息
                follow: 0, //跟进提醒
                subscriptionBook: 0, //认购书提醒
                // 今日统计
                vaildcall: 0, //今日接通通话
                noanscall: 0, //今日统计未接听通话
                lookwechatcount: 0, //查看微信次数
                allCallTimes: 0, //拨号
                abnormalNum:0, // 拨号异常
                // 系统资源跟进
                shortTerm:0, //短期客户数量
                metTerm:0, //中期客户数量
                longTerm:0, //长期客户数量
                unansweredCus:0,//未接客户
                dealCus:0, //成交


                userInfo: '',
                notificationInfo: {}
            },
            mounted: function() {
                this.netWorkStatus();
                // 获取数据
                this.fetchStatData();
                this.getMessageData();
                this.fetchNewData();
                this.fetchSystemFollowData();
                this.$nextTick(function(){
                    $(window).on('scroll',function(){
                        var sTop = $(window).scrollTop()
                        if(sTop <= 9){
                            $('#index-title').removeClass('fixbg')
                        }else{
                            $('#index-title').addClass('fixbg')
                        }
                    })
                })
            },
            filters: {
                messageFilter: function(n) {
                    return n > 99 ? '99+' : n;
                }
            },
            methods: {
                // 获取消息提醒的数据
                getMessageData: function(cb) {
                    var _this = this;
                    this.userInfo = wPref.getPrefs({
                        key: 'userInfo'
                    });
                    this.userInfo = (this.userInfo != '' ? JSON.parse(this.userInfo) : {});
                    wApiAjax({
                        url: "msgRemind/getAllNoticeCount",
                        method: 'get',
                        headers: {
                            token: TOKEN_DATA
                        },
                        data: {
                            employeeid: _this.userInfo.employeeid
                        },
                        success: function(res) {
                            // console.log('inn11111111111'+JSON.stringify(res))
                            if (res.code == 200) {
                                _this.notificationInfo = res.info || {};
                                _this.notificationInfo.switch = res.switch;
                                if (res.switch == 0) {
                                    _this.resource = 0;
                                    _this.sign = 0;
                                    _this.pay = 0;
                                    _this.change_principal = 0;
                                    _this.recovery = 0;
                                    _this.subscription = 0;
                                    _this.follow = 0;
                                    _this.subscriptionBook = 0;
                                } else {
                                    res.info = res.info || {};
                                    _this.resource = res.info.resource == 'off' ? 0 : res.info.resource;
                                    _this.sign = res.info.sign == 'off' ? 0 : res.info.sign;
                                    _this.pay = res.info.pay == 'off' ? 0 : res.info.pay;
                                    _this.change_principal = res.info.change_principal == 'off' ? 0 : res.info.change_principal;
                                    _this.recovery = res.info.recovery == 'off' ? 0 : res.info.recovery;
                                    _this.subscription = res.info.subscription == 'off' ? 0 : res.info.subscription;
                                    _this.follow = res.info.follow == 'off' ? 0 : res.info.follow;
                                    _this.subscriptionBook = res.info.subscriptionBook == 'off' ? 0 : res.info.subscriptionBook;
                                }
                            }
                            cb && typeof cb === 'function' && cb();
                        }
                    })
                },
                // 获取今日新增数据
                fetchNewData: function(cb) {
                    var _this = this;
                    this.userInfo = wPref.getPrefs({
                        key: 'userInfo'
                    });
                    this.userInfo = (this.userInfo != '' ? JSON.parse(this.userInfo) : {});
                    wDialog.showProgress();
                    wApiAjax({
                        url: 'workbench/newAddResourceFoll',
                        headers: {
                            token: TOKEN_DATA
                        },
                        data: {
                            employeeid: _this.userInfo.employeeid
                        },
                        success: function(res) {
                            console.log('today new data: '+JSON.stringify(res))
                            if (res.code == 1) {
                                _this.market = res.market;
                                _this.channel = res.channel;
                                _this.corSour = res.corSour;
                                _this.respool = res.respool;
                            }
                            wDialog.hideProgress();
                        },
                        fail: function() {

                        }
                    })
                },
                // 获取今日统计数据
                fetchStatData: function() {
                    var _this = this;
                    this.userInfo = wPref.getPrefs({
                        key: 'userInfo'
                    });
                    this.userInfo = (this.userInfo != '' ? JSON.parse(this.userInfo) : {});
                    wDialog.showProgress();
                    console.log(TOKEN_DATA)
                    wApiAjax({
                            url: 'workbench/todaySta',
                        headers: {
                            token: TOKEN_DATA
                        },
                        data: {
                            employeeid: _this.userInfo.employeeid
                        },
                        success: function(res) {
                            if (res.code == 1) {
                                _this.vaildcall = res.vaildcall;
                                _this.noanscall = res.noanscall;
                                _this.abnormalNum = res.abnormalNum;
                                _this.lookwechatcount = res.lookwechatcount;
                                _this.allCallTimes = res.allCallTimes;
                            }
                        },
                        fail: function() {

                        }
                    })
                },
                // 获取系统跟进
                fetchSystemFollowData:function(){
                    var _this = this;
                    this.userInfo = wPref.getPrefs({
                        key: 'userInfo'
                    });
                    this.userInfo = (this.userInfo != '' ? JSON.parse(this.userInfo) : {});
                    wDialog.showProgress();
                    wApiAjax({
                        url: 'workbench/sysResourceFoll',
                        headers: {
                            token: TOKEN_DATA
                        },
                        data: {
                            employeeid: _this.userInfo.employeeid
                        },
                        success: function(res) {
                            // console.log('system response data: '+JSON.stringify(res))
                            if (res.code == 1) {
                                _this.shortTerm = res.shortTerm;
                                _this.metTerm = res.metTerm;
                                _this.longTerm = res.longTerm;
                                _this.dealCus = res.dealCus;
                                _this.unansweredCus = res.unansweredCus;
                            }
                        },
                        fail: function() {

                        }
                    })
                },
                funcFormateSystemCount:function(num){
                    return num > 99 ? '99+' : num;
                },
                // 跳转到提醒列表
                skipMessage: function(i, remindName) {
                    if (i === 1) {
                        console.log('暂没有')
                    } else if (i === 2) {
                        wHrefJs.openWin({
                            name: 'customerRecycleHeader',
                            path: '../customer/customer_recycle_header.html'
                        })
                    } else {
                        wDialog.toast({
                            msg: '暂不支持查看，敬请期待'
                        })
                    }
                },
                // 判断网络状态
                netWorkStatus: function() {
                    listenOnline.offline(function() {
                        $('#offline-box').show();
                    });
                    listenOnline.online(function() {
                        $('#offline-box').hide();
                    });
                    var lineStatus = listenOnline.lineStatus();
                    if (lineStatus == 'unknown' || lineStatus == 'none' || lineStatus == '2g') {
                        $('#offline-box').show();
                    } else {
                        $('#offline-box').hide();
                    }
                },
                // 跳转到offline
                skipOfflinePage: function() {
                    wHrefJs.openWin({
                        name: 'offline',
                        path: '../person/solution.html'
                    })
                },
                // 跳转到系统跟进列表
                handleSkipSystemList:function(origin){
                    wHrefJs.openWin({
                        name: 'systemFollowHeader',
                        path: './system_follow_header.html',
                        param: {
                            origin: origin
                        },
                        bgColor: '#f7f7f7'
                    })
                },
                // 跳转新增
                skipNewCustomer: function(val) {
                    var self = this;
                    wHrefJs.openWin({
                        name: 'newCustomerHeader',
                        path: './new_customer_header.html',
                        param: {
                            origin: val
                        },
                        bgColor: '#f7f7f7'
                    })
                },
                // 跳转到今日统计
                skipStat: function(txt) {
                    var _this = this;
                    wHrefJs.openWin({
                        name: 'indexStat',
                        path: './index_stat.html',
                        param: {
                            statTypeTxt:txt
                        }
                    })
                },
                // 跳转到新增客户
                handleSkipAddCustomer:function(){
                    wHrefJs.openWin({
                        name:'addCustomer',
                        path:'./add_customer.html',
                    })
                }
            }
        })
    }
    // 刷新数据
    function refrshIndexData() {
        indexV.fetchNewData()
        indexV.fetchStatData();
        indexV.getMessageData();
        indexV.fetchSystemFollowData();
    }
</script>

</html>
