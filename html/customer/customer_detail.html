<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>客户-详情</title>
    <script src="../../script/lib/rem.js"></script>
    <script src="../../script/lib/fastclick.js"></script>
    <link rel="stylesheet" type="text/css" href="../../css/lib/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/lib/dialog.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
    <link rel="stylesheet" type="text/css" href="../../css/customer/customer.css" />
    <style media="screen">
        body,html{
            height: 100%;
        }
        #wrapper{
            min-height: 100%;
            overflow-x: hidden;
            overflow-y: scroll;
            -webkit-overflow-scrolling:touch;
        }
        .loading {
            display: inline-block;
            vertical-align: middle;
            position: relative;
            top: -1px;
            margin-right: 6px;
            /*固定loading*/
            width: 0.28rem;
            height: 0.28rem;
            border: 2px solid;
            border-color: #fff #fff transparent;
            border-radius: 50%;
            box-sizing: border-box;
            /*动画时间1s，线性变化，无限循环*/
            animation: loading 1s linear infinite;
        }

        @keyframes loading {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="wrapper" v-cloak>
        <div class="cd-header" id="cd-header">
            <div class="back-box flex-wrap flex-between" id="back-box">
                <div class="back" onclick="wBackThisFunc()"></div>
                <div class="header-txt">
                    <span :class="{'curr':isShowDetailBox}" @click="switchTab(true)"><i></i>跟进信息</span>
                    <span :class="{'curr':!isShowDetailBox}" @click="switchTab(false)"><i></i>意向资料</span>
                </div>
                <div class="right"></div>
            </div>
            <div class="hname" id="scroll-hname">
                <span v-text="cusInfo.cusName"></span>
            </div>
            <div class="horigin">客户来源：<span v-text="cusInfo.source"></span></div>
        </div>
        <section>
            <div class="cd-caption" id="js_cd_cap">
                <div class="cd-ct w-inline-block" v-if="!isShowWechat">
                    <span>微信号：</span><span v-text="cusInfo.wechat"></span><span class="look" @click="lookWechat">查看微信</span>
                </div>
                <div class="cd-ct w-inline-block" v-if="isShowWechat">
                    <span>微信号：</span><span v-text="wechatCard"></span><span class="look" @click.stop="copyWechatFn">复制</span>
                </div>
                <div class="cd-cb">
                    <div class="cd-name" v-if="cusInfo.markName">
                        <span v-if="cusInfo.markName">销售负责人：</span><span v-if="cusInfo.markName" v-text="cusInfo.markName"></span>
                    </div>
                    <!-- <span class="line"><em v-if="cusInfo.markName && cusInfo.chanName" style="font-style:normal;color:#eee;">|</em></span> -->
                    <div class="cd-name" v-if="cusInfo.chanName">
                        <span v-if="cusInfo.chanName">渠道负责人：</span><span v-if="cusInfo.chanName" v-text="cusInfo.chanName"></span>
                    </div>
                </div>
            </div>
            <div class="cd-contain">
                <div class="cd-nav" id="js_cd_nav">
                    <div class="cd-nav-ab flex-wrap">
                        <div class="flex-con cd-n" :class="{'curr':isShowDetailBox}" @click="switchTab(true)">跟进信息(<span v-text="cusCount"></span>) <i></i></div>
                        <div class="flex-con cd-n" :class="{'curr':!isShowDetailBox}" @click="switchTab(false)">意向资料<i></i></div>
                    </div>
                    <div class="cd-nav-place"></div>
                </div>
                <!-- <transition name="fade"> -->
                    <div class="cd-box cd-box0" v-show="isShowDetailBox">
                        <div class="cd-flow" v-for="(flow,index) in cusInfoList" :key="index">
                            <div class="cd-flow-sicon" :class="[judgeIcon(flow.contactway_vaule)]"></div>
                            <div class="cd-flow-t" v-if="flow.result" v-text="flow.result"></div>
                            <!-- <div class="cd-flow-all">全文</div> -->
                            <div class="cd-flow-audio" v-if="flow.callStatus" :class="{'disabled':flow.callStatus&&!flow.callStatusUrl}" @click="handlePlayAudio($event)">
                                <div class="audio audio-box" v-if="flow.callStatus && flow.callStatusUrl">
                                    <audio :src="baseUrl+flow.callStatusUrl"></audio>
                                </div>
                                <div class="audio-txt clear"><i class="icon pause-icon fl"></i><span class="fr">点击收听</span></div>
                            </div>
                            <div class="cd-flow-p w-inline-block" v-if="flow.followperson"><span>跟进员工：</span><span class="name" v-text="flow.followperson"></span></div>
                            <div class="cd-flow-timebox" v-if="flow.followtime || flow.nextfollow || flow.meetaddress">
                                <i class="top-icon"></i>
                                <div class="gj-time gj" v-if="flow.followtime"><i></i>跟进时间: <span v-text="flow.followtime||'暂未跟进'"></span></div>
                                <div class="gj-plan gj" v-if="flow.nextfollow"><i></i>计划跟进时间: <span v-text="flow.nextfollow||'暂无计划'"></span></div>
                                <div class="gj-addr gj" v-if="flow.meetaddress"><i></i>跟进地址: <span v-text="flow.meetaddress"></span></div>
                            </div>
                        </div>
                    </div>
                <!-- </transition> -->
                <!-- <transition name="fade1"> -->
                    <div class="cd-box cd-box1" v-show="!isShowDetailBox">
                        <div class="cd-info" v-if="cusPersonInfo">
                            <div class="cd-info-lis clear" v-if="cusPersonInfo.city">
                                <div class="fl left">意向城市</div>
                                <div class="fl right" v-text="cusPersonInfo.city"></div>
                            </div>
                            <div class="cd-info-lis clear" v-if="cusPersonInfo.premises">
                                <div class="fl left">意向楼盘</div>
                                <div class="fl right" v-text="cusPersonInfo.premises"></div>
                            </div>
                            <div class="cd-info-lis clear" v-if="cusPersonInfo.housestyle">
                                <div class="fl left">意向房型</div>
                                <div class="fl right" v-text="cusPersonInfo.housestyle"></div>
                            </div>
                            <div class="cd-info-lis clear" v-if="cusPersonInfo.purpose">
                                <div class="fl left">购房用途</div>
                                <div class="fl right" v-text="cusPersonInfo.purpose"></div>
                            </div>
                            <div class="cd-info-lis clear" v-if="cusPersonInfo.comment">
                                <div class="fl left">客户备注</div>
                                <div class="fl right" v-text="cusPersonInfo.comment"></div>
                            </div>
                        </div>
                    </div>
                <!-- </transition> -->
            </div>
            <div class="cd-btm-btn">
                <div class="cd-btn flex-wrap">
                    <div class="flex-con phone-follow-btn follow-btn" @click="callPhone(event)"><i></i>电话跟进</div>
                    <div class="flex-con note-follow-btn follow-btn disabled" @click="skipNoteList"><i></i>短信跟进</div>
                </div>
            </div>
            <input type="hidden" id="scroll-val" value="0">
        </section>

        <!-- 短信验证码 -->
        <div class="verification_code" v-if="isShowVerify">
           <div class="shade" ontouchmove="event.preventDefault();"></div>
           <div class="content">
               <div class="content_code">
                   <div class="close right" @click="closeCodeVerify"><img src="../../image/icon-dh-guanbi.png"></div>
                   <div class="short_message">短信验证</div>
                   <div class="text_tel">
                       查看微信需要短信确认，验证码已发送至您的手机<span v-text="minePhone"></span> <span class="timer_r" v-show='!isShowCodeDown' @click="getCodeFn" v-text="getCodeText"></span><span v-show="isShowCodeDown" class="timer_r">{{downCountTime}}s</span>
                   </div>
                   <div class="tel_num">
                       <label for="code">
                         <ul class="security-code-container">
                             <li class="field-wrap" :class="{'active':index<value.length}" v-for="(item, index) in number" :key="index">
                              <i class="char-field">{{value[index]}}</i>
                             </li>
                         </ul>
                        </label>
                        <input ref="input" class="input-code" @keyup="handleInput($event)" v-model="value"
                          id="code" name="code" type="tel" minlength="6" maxlength="6"
                          autocorrect="off" autocomplete="off" autocapitalize="off">
                    </div>
                    <div class="submit space-between">
                        <div class="text-align" v-show="!isVerifyIng" :class="{'submitClick' : isActive}" @click="handleSubmit">立即验证</div>
                        <div class="text-align submitClick" v-show="isVerifyIng"><span class="loading"></span>验证中</div>
                    </div>
               </div>
           </div>
        </div>
        <!-- 跟进记录弹窗 -->
        <follow-record :is-show-follow.sync="isShowFollow" :follow-curr-id="followCurrId" :follow-curr-phone="followCurrPhone" @refresh-view="refreshView"></follow-record>

    </div>
</body>
<script type="text/javascript" src="../../script/lib/api.js"></script>
<script type="text/javascript" src="../../script/lib/jquery_3.1.1.min.js"></script>
<script type="text/javascript" src="../../script/lib/md5.js"></script>
<script type="text/javascript" src="../../script/lib/dialog.js"></script>
<script type="text/javascript" src="../../script/lib/vue.min.js"></script>
<script type="text/javascript" src="../../script/lib/vue_lazyload.min.js"></script>
<script type="text/javascript" src="../../script/lib/api_ajax.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script>
    var cusDetailV = null;
    apiready = function() {
        $api.fixStatusBar($('#cd-header')[0]);
        $api.fixStatusBar($('#back-box')[0]);

        var param = api.pageParam;
        // 下拉加载更多
        api.addEventListener({
            name: 'scrolltobottom',
            extra:{
                threshold:8
            }
        }, function(ret, err){
            // console.log('-----------------------------------')
            if(cusDetailV.isShowDetailBox){
                if(++cusDetailV.pageNo <= cusDetailV.totalPage){
                    cusDetailV.fetchData(true);
                }
            }
        });

        // 跟进成功
        api.addEventListener({
            name: 'followRecordSuccessRefresh'
        }, function(ret, err){
            cusDetailV.pageNo = 1;
            cusDetailV.fetchData();
        });
        cusDetailV = new Vue({
            el:'#wrapper',
            data:{
                cusId:0,
                cusPhone:'',
                pageNo:1,
                totalPage:1,
                isShowDetailBox:true,
                cusPersonInfo:{}, // 意向资料
                cusInfoList:[], // 跟进信息列表
                cusInfo:{},   // 跟进信息
                wechatCard:'',  // 微信号
                cusCount:0,
                isShowWechat:false,
                minePhone:'',
                // 短信验证
                isShowVerify:false,
                isActive:false,
                // 倒计时
                downCountTime:60,
                downTimer:null,
                number:6,
                value:'',
                isVerifyIng:false,
                userInfo:{},

                isShowCodeDown:false,
                getCodeText:'立即发送',
                // 是否显示跟进弹窗
                isShowFollow:false,
                followCurrPhone:'',
                followCurrId:'',
                baseUrl:__CONFIG__.baseUrl,
                // 当前播放的dom
                currHandlePlayTag:null,
                isHandlePlay:false
            },
            created:function(){
                this.cusId = param.cusId;
                this.cusPhone = param.cusPhone
                this.userInfo = wPref.getPrefs({
                    key:'userInfo'
                });
                this.userInfo = this.userInfo ? JSON.parse(this.userInfo) : {};
            },
            mounted:function(){
                this.getUserInfo();
                this.fetchData();
            },
            watch:{
                isShowDetailBox:function(nv){
                    if(nv === false){
                        $('#scroll-val').val('0');
                        $('#back-box .header-txt').hide();
                        $('#back-box').removeClass('curr');
                    }
                },
                value:function(nv){
                    if(nv.length >= 6){
                        this.isActive = true;
                    }
                }
            },
            methods:{
                getUserInfo: function() {
                    var _this = this
                    wApiAjax({
                        method: "get",
                        url: 'perCenter/info',
                        withCredentials: true,
                        headers: {
                            "token": TOKEN_DATA,
                        },
                        data: {
                            employeeid: _this.userInfo.employeeid,
                        },
                        success: function(res) {
                            console.log(JSON.stringify(res))
                            if(res.code == 200){
                                _this.minePhone = res.info.phone.substring(0,3)+'****'+res.info.phone.substring(7);
                                if(_this.userInfo.phone != res.info.phone){
                                    _this.userInfo.phone = res.info.phone;
                                    wPref.setPrefs({
                                        key:'userInfo',
                                        value:_this.userInfo
                                    })
                                }
                            }
                        }
                    })
                },
                fetchData:function(isLoadMore){
                    isLoadMore = typeof isLoadMore === 'undefined' || isLoadMore == false ? false : true;
                    var _this = this;
                    wDialog.showProgress();
                    wApiAjax({
                        url:'customer/getcusinfo',
                        headers:{
                            "token":TOKEN_DATA
                        },
                        data:{
                            employeeid:_this.userInfo.employeeid,
                            customerid:_this.cusId,
                            pageNo:_this.pageNo,
                            pageSize:10
                        },

                        success:function(res){
                            console.log(JSON.stringify(res))
                            wDialog.hideProgress();
                            if(res.code == 1){
                                if(!isLoadMore){
                                    _this.cusInfo = res.data.cusInfo;
                                    if(res.data.cusInfo && res.data.cusInfo.wechat.indexOf('****') > -1){
                                        _this.isShowWechat = false;
                                    }else{
                                        _this.isShowWechat = true;
                                        _this.wechatCard = res.data.cusInfo.wechat.trim();
                                    }
                                    _this.cusPersonInfo = res.data.cusPurInfo[0];
                                    _this.cusInfoList = res.data.cusFllowInfo;
                                    _this.totalPage = Math.ceil(res.followcount / res.pageSize);
                                    _this.cusCount = res.followcount;
                                    _this.$nextTick(function(){
                                        var sinnerWid = $('#scroll-hname').width();
                                        var sspWid = $('#scroll-hname > span').outerWidth();
                                        var caWid = Math.floor(sspWid - sinnerWid);
                                        var step = 80;
                                        var initStep = 0;
                                        if(caWid > 0){
                                            // setInterval(function(){
                                                // initStep += step
                                                // if(initStep >= caWid){
                                                //     initStep = 0;
                                                //     $('#scroll-hname > span').css({
                                                //         'margin-left':0
                                                //     })
                                                // }else{
                                                    xunhuanScroll();
                                                    function xunhuanScroll(){
                                                        $('#scroll-hname > span').animate({
                                                            'margin-left':-caWid
                                                        },caWid * 12,'linear',function(){
                                                            $('#scroll-hname > span').css({
                                                                'margin-left':0
                                                            });
                                                            xunhuanScroll();
                                                        })
                                                    }
                                                // }
                                            // },1);
                                        }
                                    })
                                }
                                else{
                                    if(res.data && res.data.cusFllowInfo){
                                        _this.cusInfoList = _this.cusInfoList.concat(res.data.cusFllowInfo);
                                    }
                                }

                            }else{
                                wDialog.toast({
                                    msg:res.msg
                                })
                            }
                        }
                    })
                },
                // 切换 跟进信息 和 意向资料
                switchTab:function(bool){
                    this.isShowDetailBox = bool;
                },
                // 判断是通过什么方式联系的，显示不同的icon
                judgeIcon:function(i){
                    var iconClass = 'cd-flow-sicon';
                    // 电话
                    if(i === 1){
                        return iconClass+'3';
                    }
                    // 短信
                    else if(i === 2){
                        return iconClass+'6';
                    }
                    // 邮箱
                    else if(i === 3){
                        return iconClass+'4';
                    }
                    // 微信、qq
                    else if(i === 4){
                        return iconClass+'2';
                    }
                    // 面访
                    else if(i === 9){
                        return iconClass+'1';
                    }
                    else{
                        return iconClass+'4';
                    }
                },
                // 发送验证码
                getCodeFn:function(){
                    var _this = this;
                    clearInterval(_this.downTimer);
                    this.downCountTime = 60;
                    this.downCount();
                    this.isShowCodeDown = true;
                    this.getCodeText = '再次发送';
                    wApiAjax({
                        url:"phoneauth/authen",
                        headers:{
                            token:TOKEN_DATA
                        },
                        data:{
                            account:_this.userInfo.account,
                            employeeid:_this.userInfo.employeeid,
                            phone:_this.userInfo.phone,
                            type:2
                        },
                        success:function(res){
                            console.log(JSON.stringify(res));
                            if(res.code == 4){
                                wDialog.toast({
                                    msg:'发送验证码成功'
                                });
                            }else{
                                clearInterval(_this.downTimer);
                                wDialog.toast({
                                    msg:res.msg
                                });
                                _this.isShowCodeDown = false;
                                _this.getCodeText = '再次发送';
                            }
                        },
                        fail:function(){
                            clearInterval(_this.downTimer);
                            _this.isShowCodeDown = false;
                            _this.getCodeText = '再次发送';
                        }
                    })
                },
                // 倒计时
                downCount:function(){
                    var _this = this;
                    this.downTimer = setInterval(function(){
                        --_this.downCountTime;
                        if(_this.downCountTime <= 0){
                            _this.downCountTime = 60;
                            clearInterval(_this.downTimer);
                            _this.isShowCodeDown = false;
                        }
                    },1000);
                },
                // 输入
                handleInput:function(e) {
                    this.$refs.input.value = this.value;
                    console.log(this.value)
                    var tag = e.currentTarget;
                    $(tag)[0].selectionStart = this.value.length;
                    $(tag)[0].selectionEnd = this.value.length;
                    if (this.value.length >= this.number) {
                        // this.hideKeyboard();
                        this.isActive = true;
                    }else{
                        this.isActive = false;
                    }
                    // this.handleSubmit()
                },
                // 输入完成隐藏键盘
                hideKeyboard:function() {
                    // document.activeElement.blur() // ios隐藏键盘
                    // this.$refs.input.blur(); // android隐藏键盘
                },
                // 提交短信验证码，获取微信号
                handleSubmit:function(){
                    var _this = this;
                    if(this.isActive){
                        this.isVerifyIng = true;
                        wApiAjax({
                            url:'phoneauth/bind',
                            headers:{
                                token:TOKEN_DATA
                            },
                            data:{
                                account:_this.userInfo.account,
                                employeeid:_this.userInfo.employeeid,
                                phone:_this.userInfo.phone,
                                type:2,
                                authcode:_this.value,
                                cusid:_this.cusId
                            },
                            success:function(res){
                                console.log(JSON.stringify(res))
                                if(res.code == 5 && res.wechat){
                                    // 认证成功
                                    _this.isShowVerify = false;
                                    _this.isShowWechat = true;
                                    _this.wechatCard = res.wechat;
                                    clearInterval(_this.downTimer);
                                }else{
                                    _this.isVerifyIng = false;
                                    wDialog.toast({
                                        msg:res.msg
                                    })
                                }
                            },
                            fail:function(){
                                _this.isVerifyIng = false;
                            }
                        })
                    }
                },
                // 复制微信号
                copyWechatFn:function(){
                    var clipBoard = api.require('clipBoard'),
                        _this = this;
                    clipBoard.set({
                        value: _this.wechatCard
                    }, function(ret, err) {
                        console.log(JSON.stringify(ret));
                        console.log(JSON.stringify(err));
                        if(ret.status){
                            wDialog.toast({
                                msg:'复制成功'
                            })
                        }
                    });
                },
                // 查看微信号
                lookWechat:function(){
                    this.isShowVerify = true;
                },
                closeCodeVerify:function(){
                    this.isShowVerify = false;
                },
                // 跳转到短信跟进列表
                skipNoteList:function(){
                    wDialog.toast({
                        msg:'暂不支持，敬请期待'
                    })
                    // var _this = this;
                    // wHrefJs.openWin({
                    //     name:'noteTemplate',
                    //     path:'../note/note_template.html',
                    //     param:{
                    //         cusId:_this.cusId,
                    //         cusPhone:_this.cusPhone
                    //     }
                    // })
                },
                // 拨打电话
                callPhone: function(e) {
                    this.isShowFollow = true;
                    this.followCurrId = this.cusId;
                    this.followCurrPhone = this.cusPhone;
                },
                refreshView:function(){
                    this.pageNo = 1;
                    this.fetchData();
                },
                // 播放
                handlePlayAudio:function(e){
                    var tag = e.currentTarget;
                    var _this = this;
                    // console.log('----------------------')
                    if(!$(tag).hasClass('disabled')){
                        var audioEle = $(tag).find('.audio-box audio')[0];
                        var audioTxtEle = $(tag).find('.audio-txt')[0];
                        if(audioEle){
                            if(_this.currHandlePlayTag === audioEle){
                                // console.log('innnnnnnnnn2222')
                                if(_this.isHandlePlay = !_this.isHandlePlay){;
                                    $(audioTxtEle).removeClass('playing');
                                    audioEle.removeEventListener('ended',function(){})
                                    audioEle.pause()
                                }else{
                                    $(audioTxtEle).addClass('playing');
                                    audioEle.play();
                                    audioEle.addEventListener('ended',function(){
                                        console.log('innnn-----------end1')
                                        $(audioTxtEle).removeClass('playing');
                                    })
                                }
                            }else{
                                $('.audio-box audio').each(function(i,d){
                                    if(audioEle === d){
                                            $(audioTxtEle).addClass('playing');
                                            _this.isHandlePlay = false;
                                            audioEle.load();
                                            audioEle.play();
                                            // if(_this.currHandlePlayTag){
                                            //     _this.currHandlePlayTag.removeEventListener('ended',function(){})
                                            // }
                                            audioEle.addEventListener('ended',function(){
                                                console.log('innnn-----------end2')
                                                $(audioTxtEle).removeClass('playing');
                                            })
                                            _this.currHandlePlayTag = audioEle;
                                    }else{
                                        $(d).parent().siblings('.audio-txt').removeClass('playing');
                                        d.removeEventListener('ended',function(){})
                                        d.pause();
                                    }
                                });
                            }
                            // audioEle.addEventListener('ended',function(){
                            //     console.log('innnn-----------end')
                            //     $(audioTxtEle).removeClass('playing');
                            // })
                        }
                        else{
                            wDialog.toast({
                                msg:'暂没有播放文件'
                            })
                        }
                    }
                }
            }
        })
        // 屏幕滚动
        var isEventScroll = true;
        var capOffsetTop = $('#js_cd_cap').offset().top - 40;
        var navOffsetTop = $("#js_cd_nav").offset().top;
        $(window).on('scroll',function(){
            if(isEventScroll){
                var val = $('#scroll-val').val();
                isEventScroll = false;
                var wTop = $(this).scrollTop();
                // console.log(wTop)
                if(wTop >= capOffsetTop){
                    $('#back-box').addClass('curr');
                    if(wTop >= navOffsetTop){
                        // console.log('--------------------'+val);
                        if(val == 0){
                            $('#scroll-val').val('1');
                            $('#back-box .header-txt').show();
                        }
                    }else{
                        $('#scroll-val').val('0');
                        $('#back-box .header-txt').hide();
                    }
                }else{
                    $('#scroll-val').val('0');
                    $('#back-box .header-txt').hide();
                    $('#back-box').removeClass('curr');
                }
                setTimeout(function(){
                    isEventScroll = true;
                },30);
            }
        })
    }
</script>

</html>
