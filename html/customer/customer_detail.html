<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>客户-详情</title>
    <script src="../../script/lib/rem.js"></script>
    <script src="../../script/lib/fastclick.js"></script>
    <link rel="stylesheet" type="text/css" href="../../css/lib/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/lib/dialog.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
    <link rel="stylesheet" type="text/css" href="../../css/customer/customer.css" />
    <style media="screen">
        body{
            overflow: hidden;
        }

        .loading {
            display: inline-block;
            vertical-align: middle;
            position: relative;
            top: -1px;
            margin-right: 6px;
            /*固定loading*/
            width: 0.4rem;
            height: 0.4rem;
            border: 2px solid;
            border-color: #fff #fff transparent;
            border-radius: 50%;
            box-sizing: border-box;
            /*动画时间1s，线性变化，无限循环*/
            animation: loading 1s linear infinite;
        }

        @keyframes loading {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="wrapper" v-cloak>
        <div class="cd-header" id="cd-header">
            <div class="back-box flex-wrap flex-between" id="back-box">
                <div class="back" onclick="wBackThisFunc()"></div>
                <div class="header-txt">
                    <span :class="{'curr':isShowDetailBox}" @click="switchTab(true)"><i></i>跟进信息</span>
                    <span :class="{'curr':!isShowDetailBox}" @click="switchTab(false)"><i></i>意向资料</span>
                </div>
                <div class="right"></div>
            </div>
            <div class="hname" v-text="cusInfo.cusName"></div>
            <div class="horigin">客户来源：<span v-text="cusInfo.source"></span></div>
        </div>
        <section>
            <div class="cd-caption" id="js_cd_cap">
                <div class="cd-ct w-inline-block" v-if="!isShowWechat">
                    <span>微信号：</span><span v-text="cusInfo.wechat"></span><span class="look" @click="lookWechat">查看微信</span>
                </div>
                <div class="cd-ct w-inline-block" v-if="isShowWechat">
                    <span>微信号：</span><span v-text="wechatCard"></span><span class="look" @click.stop="copyWechatFn">复制</span>
                </div>
                <div class="cd-cb w-inline-block">
                    <span v-if="cusInfo.markName">销售负责人：</span><span v-if="cusInfo.markName" v-text="cusInfo.markName"></span><span class="line"><em v-if="cusInfo.markName && cusInfo.chanName" style="font-style:normal;">|</em></span><span v-if="cusInfo.chanName">渠道负责人：</span><span v-if="cusInfo.chanName" v-text="cusInfo.chanName"></span>
                </div>
            </div>
            <div class="cd-contain">
                <div class="cd-nav" id="js_cd_nav">
                    <div class="cd-nav-ab flex-wrap">
                        <div class="flex-con cd-n" :class="{'curr':isShowDetailBox}" @click="switchTab(true)">跟进信息(<span v-text="cusCount"></span>) <i></i></div>
                        <div class="flex-con cd-n" :class="{'curr':!isShowDetailBox}" @click="switchTab(false)">意向资料<i></i></div>
                    </div>
                    <div class="cd-nav-place"></div>
                </div>
                <transition name="fade">
                    <div class="cd-box cd-box0" v-show="isShowDetailBox">
                        <div class="cd-flow" v-for="(flow,index) in cusInfoList" :key="index">
                            <div class="cd-flow-sicon" :class="[judgeIcon(flow.contactway_vaule)]"></div>
                            <div class="cd-flow-t" v-if="flow.result" v-text="flow.result"></div>
                            <!-- <div class="cd-flow-all">全文</div> -->
                            <!-- <div class="cd-flow-audio disabled">
                                <div class="audio"></div>
                                <div class="audio-txt clear"><i class="icon pause-icon fl"></i><span class="fr">点击收听</span></div>
                            </div> -->
                            <div class="cd-flow-p w-inline-block" v-if="flow.markName"><span>销售负责人：</span><span class="name" v-text="flow.markName"></span></div>
                            <div class="cd-flow-timebox" v-if="flow.followtime || flow.nextfollow || flow.meetaddress">
                                <i class="top-icon"></i>
                                <div class="gj-time gj" v-if="flow.followtime"><i></i>跟进时间: <span v-text="flow.followtime"></span></div>
                                <div class="gj-plan gj" v-if="flow.nextfollow"><i></i>计划跟进时间: <span v-text="flow.nextfollow"></span></div>
                                <div class="gj-addr gj" v-if="flow.meetaddress"><i></i>跟进地址: <span v-text="flow.meetaddress"></span></div>
                            </div>
                        </div>
                    </div>
                </transition>
                <transition name="fade1">
                    <div class="cd-box cd-box1" v-show="!isShowDetailBox">
                        <div class="cd-info">
                            <div class="cd-info-lis clear" v-if="cusPersonInfo.city">
                                <div class="fl left">意向城市</div>
                                <div class="fl right" v-text="cusPersonInfo.city"></div>
                            </div>
                            <div class="cd-info-lis clear" v-if="cusPersonInfo.premises">
                                <div class="fl left">意向楼盘</div>
                                <div class="fl right" v-text="cusPersonInfo.premises"></div>
                            </div>
                            <div class="cd-info-lis clear" v-if="cusPersonInfo.housestyle">
                                <div class="fl left">意向房型</div>
                                <div class="fl right" v-text="cusPersonInfo.housestyle"></div>
                            </div>
                            <div class="cd-info-lis clear" v-if="cusPersonInfo.purpose">
                                <div class="fl left">购房用途</div>
                                <div class="fl right" v-text="cusPersonInfo.purpose"></div>
                            </div>
                            <div class="cd-info-lis clear" v-if="cusPersonInfo.comment">
                                <div class="fl left">客户备注</div>
                                <div class="fl right" v-text="cusPersonInfo.comment"></div>
                            </div>
                        </div>
                    </div>
                </transition>
            </div>
            <!-- 短信验证码 -->
            <div class="verification_code" v-if="isShowVerify">
               <div class="shade"></div>
               <div class="content">
                   <div class="content_code">
                       <div class="close right" @click="closeCodeVerify"><img src="../../image/icon-dh-guanbi.png"></div>
                       <div class="short_message">短信验证</div>
                       <div class="text_tel">
                           查看微信需要短信确认，验证码已发送至您的手机<span>152****0654</span> <span class="timer_r">{{downCountTime}}s</span>
                       </div>
                       <div class="tel_num">
                           <label for="code">
                             <ul class="security-code-container">
                                 <li class="field-wrap" v-for="(item, index) in number" :key="index">
                                  <i class="char-field">{{value[index]}}</i>
                                 </li>
                             </ul>
                            </label>
                            <input ref="input" class="input-code" @keyup="handleInput($event)" v-model="value"
                              id="code" name="code" type="tel" minlength="6" maxlength="6"
                              autocorrect="off" autocomplete="off" autocapitalize="off">
                        </div>
                        <div class="submit space-between">
                            <div class="text-align" v-if="!isVerifyIng" :class="{'submitClick' : isActive}" @click="handleSubmit">立即验证</div>
                            <div class="text-align submitClick" v-else><span class="loading"></span>验证中</div>
                        </div>
                   </div>
               </div>
            </div>
        </section>
    </div>
</body>
<script type="text/javascript" src="../../script/lib/api.js"></script>
<script type="text/javascript" src="../../script/lib/jquery_3.1.1.min.js"></script>
<script type="text/javascript" src="../../script/lib/md5.js"></script>
<script type="text/javascript" src="../../script/lib/dialog.js"></script>
<script type="text/javascript" src="../../script/lib/vue.min.js"></script>
<script type="text/javascript" src="../../script/lib/vue_lazyload.min.js"></script>
<script type="text/javascript" src="../../script/lib/api_ajax.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script>
    var cusDetailV = null;
    apiready = function() {
        $api.fixStatusBar($('#cd-header')[0]);
        $api.fixStatusBar($('#back-box')[0]);

        var param = api.pageParam;
        // 下拉加载更多
        api.addEventListener({
            name: 'scrolltobottom'
        }, function(ret, err){
            if(cusDetailV.isShowDetailBox){
                if(++cusDetailV.pageNo <= cusDetailV.totalPage){
                    cusDetailV.fetchData(true);
                }
            }
        });


        cusDetailV = new Vue({
            el:'#wrapper',
            data:{
                cusId:0,
                pageNo:1,
                totalPage:1,
                isShowDetailBox:true,
                cusPersonInfo:{}, // 意向资料
                cusInfoList:[], // 跟进信息列表
                cusInfo:{},   // 跟进信息
                wechatCard:'',  // 微信号
                cusCount:0,
                isShowWechat:false,
                // 短信验证
                isShowVerify:false,
                isActive:false,
                // 倒计时
                downCountTime:60,
                downTimer:null,
                number:6,
                value:'',
                isVerifyIng:false,
                userInfo:{},
                token:"",

            },
            created:function(){
                this.cusId = param.cusId;
                this.userInfo = wPref.getPrefs({
                    key:'userInfo'
                });
                this.userInfo = this.userInfo ? JSON.parse(this.userInfo) : {};
                this.token = wPref.getPrefs({
                    key:'token'
                });
            },
            mounted:function(){
                this.fetchData();
            },
            watch:{
                isShowVerify:function(nv,ov){
                    if(nv === true){
                        this.getCode();
                        this.downCount();
                    }
                }
            },
            methods:{
                fetchData:function(isLoadMore){
                    isLoadMore = typeof isLoadMore === 'undefined' || isLoadMore == false ? false : true;
                    var _this = this;
                    wDialog.showProgress();
                    wApiAjax({
                        url:'customer/getcusinfo',
                        headers:{
                            "token":_this.token
                        },
                        data:{
                            employeeid:_this.userInfo.employeeid,
                            customerid:_this.cusId,
                            pageNo:_this.pageNo,
                            pageSize:10
                        },

                        success:function(res){
                            console.log(JSON.stringify(res))
                            wDialog.hideProgress();
                            if(res.code == 1){
                                if(!isLoadMore){
                                    _this.cusInfo = res.data.cusInfo;
                                    _this.cusPersonInfo = res.data.cusPurInfo[0];
                                    _this.cusInfoList = res.data.cusFllowInfo;
                                    _this.totalPage = res.followcount / res.pageSize;
                                    _this.cusCount = res.followcount;
                                }
                                else{
                                    if(res.data && res.data.cusFllowInfo){
                                        _this.cusInfoList = _this.cusInfoList.concat(res.data.cusFllowInfo);
                                    }
                                }

                            }else{
                                wDialog.toast({
                                    msg:res.msg
                                })
                            }
                        }
                    })
                },
                // 切换 跟进信息 和 意向资料
                switchTab:function(bool){
                    this.isShowDetailBox = bool;
                },
                // 判断是通过什么方式联系的，显示不同的icon
                judgeIcon:function(i){
                    var iconClass = 'cd-flow-sicon';
                    // 电话
                    if(i === 1){
                        return iconClass+'3';
                    }
                    // 短信
                    else if(i === 2){
                        return iconClass+'6';
                    }
                    // 邮箱
                    else if(i === 3){
                        return iconClass+'4';
                    }
                    // 微信、qq
                    else if(i === 4){
                        return iconClass+'2';
                    }
                    // 面访
                    else if(i === 9){
                        return iconClass+'1';
                    }
                    else{
                        return iconClass+'4';
                    }
                },
                // 发送验证码
                getCode:function(){
                    var _this = this;
                    clearInterval(_this.downTimer);
                    this.downCountTime = 60;
                    wApiAjax({
                        url:"phoneauth/authen",
                        headers:{
                            token:_this.token
                        },
                        data:{
                            account:_this.userInfo.account,
                            employeeid:_this.userInfo.employeeid,
                            phone:_this.userInfo.phone,
                            type:2
                        },
                        success:function(res){
                            if(res.code == 4){

                            }else{
                                // clearInterval(_this.downTimer);
                                wDialog.toast({
                                    msg:'发送验证码失败'
                                });
                            }
                        },
                        fail:function(){
                            // clearInterval(_this.downTimer);
                        }
                    })
                },
                // 倒计时
                downCount:function(){
                    var _this = this;
                    this.downTimer = setInterval(function(){
                        --_this.downCountTime;
                        if(_this.downCountTime <= 0){
                            _this.downCountTime = 60;
                            clearInterval(_this.downTimer);
                        }
                    },1000);
                },
                // 输入
                handleInput(e) {
                    this.$refs.input.value = this.value;
                    console.log(this.value)
                    if (this.value.length >= this.number) {
                        this.hideKeyboard();
                        this.isActive = true;
                    }else{
                        this.isActive = false;
                    }
                    // this.handleSubmit()
                },
                // 输入完成隐藏键盘
                hideKeyboard() {
                    document.activeElement.blur() // ios隐藏键盘
                    this.$refs.input.blur(); // android隐藏键盘
                },
                // 提交短信验证码，获取微信号
                handleSubmit:function(){
                    var _this = this;
                    this.isVerifyIng = true;
                    wApiAjax({
                        url:'phoneauth/bind',
                        headers:{
                            token:_this.token
                        },
                        data:{
                            account:_this.userInfo.account,
                            employeeid:_this.userInfo.employeeid,
                            phone:_this.userInfo.phone,
                            type:2,
                            authcode:'',
                            cusid:_this.cusId
                        },
                        success:function(res){
                            if(res.code == 5 && res.wechat){
                                // 认证成功
                                _this.isShowVerify = false;
                                _this.isShowWechat = true;
                                _this.wechatCard = res.wechat;
                                clearInterval(_this.downTimer);
                            }else{
                                this.isVerifyIng = false;
                                wDialog.toast({
                                    msg:res.msg
                                })
                            }
                        },
                        fail:function(){
                            this.isVerifyIng = false;
                        }
                    })
                },
                // 复制微信号
                copyWechatFn:function(){
                    var clipBoard = api.require('clipBoard'),
                        _this = this;
                    clipBoard.set({
                        value: _this.wechatCard
                    }, function(ret, err) {
                        console.log(JSON.stringify(ret));
                        console.log(JSON.stringify(err));
                        if(ret.status){
                            wDialog({
                                msg:'复制成功'
                            })
                        }
                    });
                },
                // 查看微信号
                lookWechat:function(){
                    this.isShowVerify = true;
                },
                closeCodeVerify:function(){
                    this.isShowVerify = false;
                }
            }
        })
        // 屏幕滚动
        var isEventScroll = true;
        var capOffsetTop = $('#js_cd_cap').offset().top - 40;
        var navOffsetTop = $("#js_cd_nav").offset().top;
        $(window).on('scroll',function(){
            if(isEventScroll){
                isEventScroll = false;
                var wTop = $(this).scrollTop();
                // console.log(wTop)
                if(wTop >= capOffsetTop){
                    $('#back-box').addClass('curr');
                    if(wTop >= navOffsetTop){
                        $('#back-box .header-txt').show();
                        setTimeout(function(){
                            $('#back-box .header-txt').animate({opacity:1},300);
                        },100);
                    }else{
                        $('#back-box .header-txt').hide().css('opacity',0);
                    }
                }else{
                    $('#back-box').removeClass('curr');
                }
                setTimeout(function(){
                    isEventScroll = true;
                },50);
            }
        })
    }
</script>

</html>
